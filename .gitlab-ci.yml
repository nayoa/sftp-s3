image: python:3.6-alpine

stages:
  - test
  - deploy

before_script:
  - aws s3 ls
  - apk update && apk upgrade
  - apk add --no-cache build-base libffi-dev openssl-dev openssh
  - mkdir -p ~/.ssh
  - ssh-keyscan $SFTP_HOST >> ~/.ssh/known_hosts
  - cat ~/.ssh/known_hosts
  - (umask  077 ; echo $SSH_PRIVATE_KEY | base64 -d > ~/.ssh/id_rsa)
  - pip install -r requirements.txt
  - aws --version
  - aws s3 ls

variables:
  PIP_CACHE_DIR: "pip-cache"

cache:
  paths:
    - pip-cache

python_lint:
  # only:
    # refs:
    # - master
  stage: test
  script:
    - pylint shipup_s3_transfer.py


run_transfer_s3:
  # only:
  #   refs:
  #   - master
  #   - schedules
  stage: deploy
  variables:
    USER: $SFTP_USERNAME
    PASS: $SFTP_PASSWORD
    HOST: $SFTP_HOST
    BUCKET_NAME: $S3_BUCKET_DESTINATION
  script:
    - python3 shipup_s3_transfer.py


after_script:
  - rm ~/.ssh/id_rsa
  - 